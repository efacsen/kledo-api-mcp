---
phase: 04-smart-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routing/__init__.py
  - src/routing/synonyms.py
  - src/routing/date_parser.py
  - src/routing/fuzzy.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Synonym lookup returns canonical term for business terms"
    - "Bilingual terms (English + Indonesian) resolve to same canonical"
    - "Fuzzy matching handles typos (invoise -> invoice)"
    - "Date parser distinguishes calendar-based from rolling windows"
    - "Last week returns previous ISO week Mon-Sun, not rolling 7 days"
  artifacts:
    - path: "src/routing/synonyms.py"
      provides: "Bilingual synonym dictionary"
      exports: ["SYNONYM_MAP", "TERM_TO_TOOLS", "normalize_term"]
    - path: "src/routing/date_parser.py"
      provides: "Extended natural language date parsing"
      exports: ["parse_natural_date"]
    - path: "src/routing/fuzzy.py"
      provides: "Typo-tolerant term matching"
      exports: ["fuzzy_lookup"]
  key_links:
    - from: "src/routing/fuzzy.py"
      to: "src/routing/synonyms.py"
      via: "fuzzy_lookup uses SYNONYM_MAP keys"
      pattern: "SYNONYM_MAP\\.keys\\(\\)"
---

<objective>
Build the foundation components for smart routing: bilingual synonym dictionary, extended date parser, and fuzzy matching utility.

Purpose: Enable natural language business queries to resolve to canonical terms and date ranges before tool matching.
Output: Three reusable modules (synonyms, date_parser, fuzzy) that the main router will compose.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-routing/04-CONTEXT.md
@.planning/phases/04-smart-routing/04-RESEARCH.md

Key context from research:
- Use RapidFuzz 3.14+ for fuzzy matching (MIT license, fast)
- Score threshold 80+ for fuzzy match precision
- Extend existing parse_date_range() pattern in helpers.py
- ISO week calculation via datetime.isocalendar()
- 20-30 high-impact bilingual terms, manually curated
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RapidFuzz dependency + routing package structure</name>
  <files>pyproject.toml, src/routing/__init__.py</files>
  <action>
1. Add rapidfuzz>=3.14.0 to pyproject.toml dependencies
2. Create src/routing/ directory with __init__.py
3. In __init__.py, add module docstring and __all__ (will be populated as modules are created)
4. Run pip install to ensure dependency is available

Note: Do NOT add isoweek or dateparser - use stdlib only for dates.
  </action>
  <verify>
- `pip show rapidfuzz` shows version 3.14+
- `python -c "from rapidfuzz import fuzz"` succeeds
- src/routing/__init__.py exists
  </verify>
  <done>RapidFuzz installed, routing package structure created</done>
</task>

<task type="auto">
  <name>Task 2: Create bilingual synonym dictionary</name>
  <files>src/routing/synonyms.py</files>
  <action>
Create synonyms.py with:

1. SYNONYM_MAP dict: Maps alternate terms to canonical form
   - English terms: revenue->sales, income->sales, bill->invoice, bills->invoice, client->customer, clients->customer, supplier->vendor, suppliers->vendor, receivable->receivable, payable->payable
   - Indonesian terms: pendapatan->sales, penjualan->sales, faktur->invoice, tagihan->invoice, pelanggan->customer, pembeli->customer, pemasok->vendor, piutang->receivable, hutang->payable, saldo->balance, kas->cash
   - Keep it to 20-30 high-impact terms

2. TERM_TO_TOOLS dict: Maps canonical terms to relevant tools
   - sales: [financial_sales_summary, invoice_list_sales, order_list_sales]
   - invoice: [invoice_list_sales, invoice_list_purchase, invoice_get_detail, invoice_get_totals]
   - customer: [contact_list, contact_get_detail, contact_get_transactions]
   - vendor: [contact_list, invoice_list_purchase, financial_purchase_summary]
   - receivable: [invoice_get_totals, invoice_list_sales]
   - payable: [invoice_list_purchase, financial_purchase_summary]
   - balance: [financial_bank_balances]
   - cash: [financial_bank_balances]
   - product: [product_list, product_get_detail, product_search_by_sku]
   - order: [order_list_sales, order_list_purchase, order_get_detail]
   - delivery: [delivery_list, delivery_get_detail, delivery_get_pending]

3. normalize_term(term: str) -> str function:
   - Lowercase input
   - Look up in SYNONYM_MAP, return canonical if found
   - Return original lowercase if not found
  </action>
  <verify>
```python
from src.routing.synonyms import normalize_term, SYNONYM_MAP, TERM_TO_TOOLS
assert normalize_term("Revenue") == "sales"
assert normalize_term("pendapatan") == "sales"
assert normalize_term("tagihan") == "invoice"
assert normalize_term("unknown") == "unknown"
assert "invoice_list_sales" in TERM_TO_TOOLS["invoice"]
```
  </verify>
  <done>Synonym dictionary handles 20+ bilingual terms, normalize_term works case-insensitively</done>
</task>

<task type="auto">
  <name>Task 3: Create extended date parser with calendar vs rolling distinction</name>
  <files>src/routing/date_parser.py</files>
  <action>
Create date_parser.py with parse_natural_date(phrase: str) -> tuple[date, date] | None:

Handle these patterns (all case-insensitive):

Calendar-based (ISO week/month boundaries):
- "last week" / "minggu lalu" / "minggu kemarin" -> previous ISO week (Monday to Sunday)
- "this week" / "minggu ini" -> current ISO week start to today
- "this month" / "bulan ini" -> first of month to today
- "last month" / "bulan lalu" -> full previous month
- "q1" / "kuartal 1" -> Jan 1 to Mar 31
- "q2" / "kuartal 2" -> Apr 1 to Jun 30
- "q3" / "kuartal 3" -> Jul 1 to Sep 30
- "q4" / "kuartal 4" -> Oct 1 to Dec 31
- "this year" / "tahun ini" -> Jan 1 to today

Rolling windows (from today backward):
- "7 days" / "7 hari" / "tujuh hari" -> today - 7 days to today
- "30 days" / "30 hari" / "tiga puluh hari" -> today - 30 days to today
- "90 days" / "90 hari" -> today - 90 days to today

Use datetime.isocalendar() for ISO week calculation:
```python
today = date.today()
iso_year, iso_week, iso_weekday = today.isocalendar()
# Monday of current week
monday = today - timedelta(days=iso_weekday - 1)
# Previous week
prev_monday = monday - timedelta(weeks=1)
prev_sunday = prev_monday + timedelta(days=6)
```

Return None if phrase doesn't match any pattern.
  </action>
  <verify>
```python
from src.routing.date_parser import parse_natural_date
from datetime import date, timedelta

# Last week returns Mon-Sun of previous ISO week
result = parse_natural_date("last week")
assert result is not None
start, end = result
assert start.weekday() == 0  # Monday
assert end.weekday() == 6    # Sunday
assert (end - start).days == 6

# Rolling window
result = parse_natural_date("7 days")
assert result is not None
start, end = result
assert end == date.today()
assert (end - start).days == 7

# Indonesian support
assert parse_natural_date("minggu lalu") == parse_natural_date("last week")
assert parse_natural_date("bulan ini") is not None
```
  </verify>
  <done>Date parser distinguishes calendar boundaries from rolling windows, supports English and Indonesian</done>
</task>

<task type="auto">
  <name>Task 4: Create fuzzy matching utility</name>
  <files>src/routing/fuzzy.py</files>
  <action>
Create fuzzy.py with fuzzy_lookup(term: str, candidates: list[str] | None = None, threshold: int = 80) -> str | None:

1. If candidates is None, use SYNONYM_MAP.keys() as default candidates
2. Use rapidfuzz.process.extractOne with:
   - scorer=fuzz.WRatio (weighted ratio for better partial matching)
   - processor=utils.default_process (lowercase + strip non-alphanumeric)
   - score_cutoff=threshold
3. Return the matched term if found, None otherwise
4. Require minimum 3 characters in term to avoid false positives

Example usage:
```python
# Typo correction
fuzzy_lookup("invoise")  # -> "invoice"
fuzzy_lookup("custmer")  # -> "customer"
fuzzy_lookup("tagiha")   # -> "tagihan"

# Below threshold
fuzzy_lookup("xyz")      # -> None
```
  </action>
  <verify>
```python
from src.routing.fuzzy import fuzzy_lookup
assert fuzzy_lookup("invoise") == "invoice"
assert fuzzy_lookup("custmer") == "customer"
assert fuzzy_lookup("ab") is None  # Too short
assert fuzzy_lookup("xyzabc123") is None  # No match
```
  </verify>
  <done>Fuzzy lookup corrects typos with 80+ threshold, skips short terms</done>
</task>

</tasks>

<verification>
All foundation components working:
- `python -c "from src.routing import synonyms, date_parser, fuzzy"` succeeds
- Synonym normalization handles both English and Indonesian
- Date parser correctly distinguishes calendar vs rolling windows
- Fuzzy matching corrects common typos
</verification>

<success_criteria>
- RapidFuzz 3.14+ installed
- src/routing/ package created with synonyms.py, date_parser.py, fuzzy.py
- Synonym dictionary has 20+ bilingual terms mapping to canonical forms
- Date parser handles 10+ patterns (calendar and rolling)
- Fuzzy matching has 80 threshold and 3-char minimum
- All verify commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-routing/04-01-SUMMARY.md`
</output>
