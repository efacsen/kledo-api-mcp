---
phase: 01-entity-registry
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/models/order.py
  - src/entities/models/delivery.py
  - src/entities/models/account.py
  - src/entities/models/__init__.py
autonomous: true

must_haves:
  truths:
    - "Order entity has all fields used by order tools (trans_number, trans_date, contact_id, status, grand_total, detail items)"
    - "Delivery entity has all fields used by delivery tools (trans_number, contact_name, status, tracking, shipping_address, items)"
    - "Account entity has all fields used by financial tools (name, balance, currency)"
    - "Entity relationships are encoded in Field metadata (order references Contact, delivery references Order)"
  artifacts:
    - path: "src/entities/models/order.py"
      provides: "Order and OrderItem entities"
      exports: ["Order", "OrderItem"]
    - path: "src/entities/models/delivery.py"
      provides: "Delivery and DeliveryItem entities"
      exports: ["Delivery", "DeliveryItem"]
    - path: "src/entities/models/account.py"
      provides: "Account (bank) entity"
      exports: ["Account"]
  key_links:
    - from: "src/entities/models/order.py"
      to: "Contact"
      via: "contact_id field with relationship metadata"
      pattern: "relationship.*Contact"
    - from: "src/entities/models/delivery.py"
      to: "Order"
      via: "ref_number field linking to source order"
      pattern: "relationship.*Order"
---

<objective>
Create Pydantic entity models for transaction entities: Order, Delivery, and Account.

Purpose: Complete the entity model coverage for all business objects used by existing MCP tools. Order and Delivery track fulfillment workflows; Account tracks cash positions.

Output: Complete set of entity models in `src/entities/models/` covering all 7 core Kledo entities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-entity-registry/01-CONTEXT.md
@.planning/phases/01-entity-registry/01-RESEARCH.md

# Existing tools showing field usage
@src/tools/orders.py
@src/tools/deliveries.py
@src/tools/financial.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Order entity model</name>
  <files>src/entities/models/order.py</files>
  <action>
    Create Order entity based on fields from `orders.py` tool. Structure is similar to Invoice.

    ```python
    from datetime import date
    from decimal import Decimal
    from typing import Optional
    from pydantic import BaseModel, Field
    from .base import BaseEntity

    class OrderItem(BaseModel):
        """Line item within an order."""
        product_id: Optional[int] = Field(
            default=None,
            description="Product reference",
            json_schema_extra={"relationship": {"target": "Product", "type": "many-to-one"}}
        )
        desc: str = Field(description="Item description")
        qty: Decimal = Field(description="Quantity ordered")
        price: Decimal = Field(description="Unit price")
        amount: Decimal = Field(description="Line total")

    class Order(BaseEntity):
        """Sales or Purchase order."""
        trans_number: str = Field(description="Order number (e.g., SO-2026-0001)")
        trans_date: date = Field(description="Order date")
        contact_id: int = Field(
            description="Customer (sales) or Vendor (purchase) reference",
            json_schema_extra={"relationship": {"target": "Contact", "type": "many-to-one"}}
        )
        contact_name: Optional[str] = Field(default=None, description="Denormalized contact name")
        status_id: int = Field(description="Order status ID")
        status_name: Optional[str] = Field(default=None, description="Denormalized status name")
        subtotal: Decimal = Field(default=0, description="Sum of line items")
        grand_total: Decimal = Field(default=0, description="Total including adjustments")
        detail: list[OrderItem] = Field(
            default_factory=list,
            description="Order line items",
            json_schema_extra={"relationship": {"target": "OrderItem", "type": "one-to-many", "embedded": True}}
        )
        order_type: str = Field(
            default="sales",
            description="Order type: 'sales' or 'purchase'",
            json_schema_extra={"enum_values": ["sales", "purchase"]}
        )
    ```

    Note: Both sales and purchase orders share the same structure in Kledo, differentiated by `order_type`.
  </action>
  <verify>
    Run: `python -c "from src.entities.models.order import Order, OrderItem; o = Order(id=1, trans_number='SO-001', trans_date='2026-01-21', contact_id=1, status_id=1); print(o.model_dump_json())"`
  </verify>
  <done>Order and OrderItem models validate and serialize correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create Delivery entity model</name>
  <files>src/entities/models/delivery.py</files>
  <action>
    Create Delivery entity based on fields from `deliveries.py` tool:

    ```python
    from datetime import date
    from decimal import Decimal
    from typing import Optional
    from pydantic import BaseModel, Field
    from .base import BaseEntity

    class DeliveryItem(BaseModel):
        """Item being delivered."""
        product_id: Optional[int] = Field(
            default=None,
            description="Product reference",
            json_schema_extra={"relationship": {"target": "Product", "type": "many-to-one"}}
        )
        desc: str = Field(description="Item description")
        qty: Decimal = Field(description="Quantity being delivered")

    class Delivery(BaseEntity):
        """Shipment/delivery record."""
        trans_number: str = Field(description="Delivery number (e.g., DEL-2026-0001)")
        trans_date: date = Field(description="Delivery date")
        contact_id: Optional[int] = Field(
            default=None,
            description="Customer receiving delivery",
            json_schema_extra={"relationship": {"target": "Contact", "type": "many-to-one"}}
        )
        contact_name: Optional[str] = Field(default=None, description="Denormalized contact name")
        status_id: int = Field(description="Delivery status ID")
        status_name: Optional[str] = Field(default=None, description="Denormalized status name")
        shipping_company_name: Optional[str] = Field(default=None, description="Carrier/shipping company")
        tracking_number: Optional[str] = Field(default=None, description="Shipment tracking number")
        shipping_address: Optional[str] = Field(default=None, description="Destination address")
        ref_number: Optional[str] = Field(
            default=None,
            description="Reference to source order",
            json_schema_extra={"relationship": {"target": "Order", "type": "many-to-one", "via": "trans_number"}}
        )
        detail: list[DeliveryItem] = Field(
            default_factory=list,
            description="Items being delivered",
            json_schema_extra={"relationship": {"target": "DeliveryItem", "type": "one-to-many", "embedded": True}}
        )
        memo: Optional[str] = Field(default=None, description="Delivery notes")
    ```
  </action>
  <verify>
    Run: `python -c "from src.entities.models.delivery import Delivery; d = Delivery(id=1, trans_number='DEL-001', trans_date='2026-01-21', status_id=1); print(d.model_dump_json())"`
  </verify>
  <done>Delivery and DeliveryItem models validate and serialize correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create Account entity model and update exports</name>
  <files>
    src/entities/models/account.py
    src/entities/models/__init__.py
  </files>
  <action>
    Create Account entity for bank accounts based on `financial.py` tool:

    ```python
    from decimal import Decimal
    from typing import Optional
    from pydantic import Field
    from .base import BaseEntity

    class Account(BaseEntity):
        """Bank/cash account."""
        name: str = Field(description="Account name (e.g., 'BCA Checking')")
        account_number: Optional[str] = Field(default=None, description="Bank account number")
        balance: Decimal = Field(default=0, description="Current balance")
        currency: str = Field(default="IDR", description="Currency code (ISO 4217)")
        account_type: Optional[str] = Field(
            default=None,
            description="Account type (e.g., 'bank', 'cash', 'credit_card')"
        )
        is_active: bool = Field(default=True, description="Whether account is active")
    ```

    Update `src/entities/models/__init__.py` to export ALL models from both Plan 01 and Plan 02:

    ```python
    from .base import BaseEntity
    from .contact import Contact
    from .product import Product, Warehouse
    from .invoice import Invoice, InvoiceItem
    from .order import Order, OrderItem
    from .delivery import Delivery, DeliveryItem
    from .account import Account

    __all__ = [
        "BaseEntity",
        "Contact",
        "Product", "Warehouse",
        "Invoice", "InvoiceItem",
        "Order", "OrderItem",
        "Delivery", "DeliveryItem",
        "Account",
    ]
    ```

    Note: Plan 01 creates initial __init__.py; this task extends it. If Plan 01 hasn't run yet, create the full file. If it has, update the existing imports.
  </action>
  <verify>
    Run: `python -c "from src.entities.models import Order, Delivery, Account; print('All transaction models imported')"`
    Run: `python -c "from src.entities.models import *; print([m for m in dir() if not m.startswith('_')])"`
  </verify>
  <done>Account model exists; all 7 entity types export from package</done>
</task>

</tasks>

<verification>
1. All transaction models import: `from src.entities.models import Order, Delivery, Account`
2. Complete entity coverage: 7 core entities (Contact, Product, Invoice, Order, Delivery, Account) + embedded types
3. JSON schema works for all: `Order.model_json_schema()`, `Delivery.model_json_schema()`, `Account.model_json_schema()`
4. Relationship metadata present: Order.contact_id has relationship info, Delivery.ref_number references Order
</verification>

<success_criteria>
- 3 additional entity models defined (Order, Delivery, Account) + 2 embedded types (OrderItem, DeliveryItem)
- All fields from existing tools are captured
- Cross-entity relationships documented (Delivery -> Order -> Contact)
- Full export works: `from src.entities.models import *` includes all 10 types
</success_criteria>

<output>
After completion, create `.planning/phases/01-entity-registry/01-02-SUMMARY.md`
</output>
