---
phase: 05-domain-model-field-mapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/invoice_financials.py
  - src/models/__init__.py
  - src/mappers/__init__.py
  - src/mappers/kledo_mapper.py
  - tests/test_kledo_mapper.py
autonomous: true

must_haves:
  truths:
    - "InvoiceFinancials model exists with net_sales, tax_collected, gross_sales fields"
    - "Mapper correctly converts Kledo fields: subtotal->net_sales, total_tax->tax_collected, amount_after_tax->gross_sales"
    - "from_kledo_invoice() function correctly maps Kledo fields to domain model"
    - "from_kledo_invoices() handles batch conversion with skip_invalid option"
    - "aggregate_financials() sums multiple invoices correctly"
    - "Data integrity validation catches mismatched values (net + tax != gross)"
    - "All tests pass"
  artifacts:
    - path: "src/models/invoice_financials.py"
      provides: "InvoiceFinancials Pydantic model with validation"
      exports: ["InvoiceFinancials"]
    - path: "src/mappers/kledo_mapper.py"
      provides: "Kledo to domain conversion functions"
      exports: ["from_kledo_invoice", "from_kledo_invoices", "aggregate_financials"]
    - path: "tests/test_kledo_mapper.py"
      provides: "Test suite for mapper and model"
      min_lines: 100
  key_links:
    - from: "src/mappers/kledo_mapper.py"
      to: "src/models/invoice_financials.py"
      via: "imports InvoiceFinancials"
      pattern: "from src\\.models\\.invoice_financials import InvoiceFinancials"
    - from: "tests/test_kledo_mapper.py"
      to: "src/mappers/kledo_mapper.py"
      via: "tests mapper functions"
      pattern: "from src\\.mappers\\.kledo_mapper import"
    - from: "tests/test_kledo_mapper.py"
      to: "src/models/invoice_financials.py"
      via: "tests model validation"
      pattern: "from src\\.models\\.invoice_financials import"
---

<objective>
Create the foundational domain model and conversion layer for Kledo invoice financial data.

Purpose: Convert confusing Kledo API field names (`amount_after_tax`, `subtotal`, `total_tax`) to clear business terminology (`gross_sales`, `net_sales`, `tax_collected`). This establishes the foundation for all future analytics work.

Output:
- `src/models/invoice_financials.py` - Pydantic domain model
- `src/mappers/kledo_mapper.py` - Conversion functions
- `tests/test_kledo_mapper.py` - Comprehensive test suite
</objective>

<execution_context>
@~/.claude/gsd-css/workflows/execute-plan.md
@~/.claude/gsd-css/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-model-field-mapping/05-RESEARCH.md
@docs/technical/FIELD_MAPPING_DECISION.md
@tests/validate_invoice_fields.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InvoiceFinancials domain model</name>
  <files>
    - src/models/invoice_financials.py
    - src/models/__init__.py
  </files>
  <action>
Create `src/models/invoice_financials.py` with Pydantic BaseModel:

1. **InvoiceFinancials class** with:
   - `net_sales: Decimal` - Revenue before tax (from Kledo `subtotal`)
   - `tax_collected: Decimal` - PPN collected (from Kledo `total_tax`)
   - `gross_sales: Decimal` - Total including tax (from Kledo `amount_after_tax`)
   - Optional metadata: `invoice_id: Optional[int]`, `ref_number: Optional[str]`

2. **Use Pydantic v2 patterns:**
   - `model_config = ConfigDict(frozen=True)` for immutability
   - `Field(description=...)` for self-documentation
   - `@model_validator(mode='after')` for data integrity check

3. **Data integrity validation:**
   - Validate `net_sales + tax_collected = gross_sales` within tolerance (Rp 1)
   - Raise `ValueError` with clear message on mismatch

4. **Computed property:**
   - `tax_rate` property: `(tax_collected / net_sales) * 100`

5. **Update `src/models/__init__.py`:**
   - Export `InvoiceFinancials`

Reference the exact implementation from `05-RESEARCH.md` "Complete Domain Model Implementation" section.
  </action>
  <verify>
```bash
# Verify file exists and has correct structure
python -c "
from src.models.invoice_financials import InvoiceFinancials
from decimal import Decimal

# Test creation
inv = InvoiceFinancials(
    net_sales=Decimal('16320000'),
    tax_collected=Decimal('1795200'),
    gross_sales=Decimal('18115200')
)
print(f'net_sales: {inv.net_sales}')
print(f'tax_rate: {inv.tax_rate}%')
print('Model creation OK')

# Test validation failure
try:
    bad = InvoiceFinancials(
        net_sales=Decimal('1000'),
        tax_collected=Decimal('100'),
        gross_sales=Decimal('9999')
    )
    print('ERROR: Should have raised ValueError')
except ValueError as e:
    print(f'Validation OK: {e}')
"
```
  </verify>
  <done>
- InvoiceFinancials class exists with net_sales, tax_collected, gross_sales fields
- Model validator catches integrity errors (net + tax != gross)
- Tax rate property calculates correctly
- Model exported from src/models/__init__.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Create kledo_mapper conversion functions</name>
  <files>
    - src/mappers/__init__.py
    - src/mappers/kledo_mapper.py
  </files>
  <action>
Create `src/mappers/` directory structure and `kledo_mapper.py`:

1. **Create `src/mappers/__init__.py`:**
   - Export: `from_kledo_invoice`, `from_kledo_invoices`, `aggregate_financials`

2. **Create `src/mappers/kledo_mapper.py`** with three functions:

**Function 1: `from_kledo_invoice()`**
```python
def from_kledo_invoice(
    kledo_data: dict[str, Any],
    include_metadata: bool = True
) -> InvoiceFinancials:
```
- Map: `subtotal` -> `net_sales`, `total_tax` -> `tax_collected`, `amount_after_tax` -> `gross_sales`
- CRITICAL: Use `Decimal(str(value))` - never `Decimal(float_value)` directly
- Handle `InvalidOperation` and `TypeError` with clear error message
- Optionally include `invoice_id` and `ref_number` from kledo_data

**Function 2: `from_kledo_invoices()`**
```python
def from_kledo_invoices(
    kledo_invoices: list[dict[str, Any]],
    skip_invalid: bool = False,
    include_metadata: bool = True
) -> list[InvoiceFinancials]:
```
- Batch convert list of invoices
- If `skip_invalid=True`: skip failed conversions (for production resilience)
- If `skip_invalid=False`: raise on first error with invoice reference

**Function 3: `aggregate_financials()`**
```python
def aggregate_financials(invoices: list[InvoiceFinancials]) -> InvoiceFinancials:
```
- Sum all fields across invoices
- Return single InvoiceFinancials (no metadata)
- Handle empty list (return zeros)

Reference exact implementation from `05-RESEARCH.md` "Complete Mapper Implementation" section.
  </action>
  <verify>
```bash
python -c "
from src.mappers.kledo_mapper import from_kledo_invoice, from_kledo_invoices, aggregate_financials
from decimal import Decimal

# Test single conversion
inv = from_kledo_invoice({
    'subtotal': 16320000,
    'total_tax': 1795200,
    'amount_after_tax': 18115200,
    'id': 123,
    'ref_number': 'INV/26/JAN/01153'
})
assert inv.net_sales == Decimal('16320000'), 'net_sales mismatch'
assert inv.invoice_id == 123, 'invoice_id mismatch'
print('Single conversion OK')

# Test batch conversion
invoices = from_kledo_invoices([
    {'subtotal': 1000, 'total_tax': 110, 'amount_after_tax': 1110},
    {'subtotal': 2000, 'total_tax': 220, 'amount_after_tax': 2220}
], include_metadata=False)
assert len(invoices) == 2, 'batch length mismatch'
print('Batch conversion OK')

# Test aggregation
agg = aggregate_financials(invoices)
assert agg.net_sales == Decimal('3000'), 'aggregation net_sales mismatch'
assert agg.gross_sales == Decimal('3330'), 'aggregation gross_sales mismatch'
print('Aggregation OK')

print('All mapper functions working!')
"
```
  </verify>
  <done>
- src/mappers/ directory exists with __init__.py
- from_kledo_invoice() converts single invoice correctly
- from_kledo_invoices() handles batch conversion with skip_invalid option
- aggregate_financials() sums multiple invoices correctly
- All functions use Decimal(str()) pattern for precision
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive test suite</name>
  <files>tests/test_kledo_mapper.py</files>
  <action>
Create `tests/test_kledo_mapper.py` following project test conventions (see conftest.py):

**Test data** - Use real validated invoice data from `tests/validate_invoice_fields.py`:
```python
VALID_INVOICE_DATA = {
    "id": 12345,
    "ref_number": "INV/26/JAN/01153",
    "subtotal": 16320000,
    "total_tax": 1795200,
    "amount_after_tax": 18115200,
}
VALID_ZERO_TAX_DATA = {
    "id": 12346,
    "ref_number": "INV/26/JAN/01154",
    "subtotal": 4410000,
    "total_tax": 0,
    "amount_after_tax": 4410000,
}
```

**Test classes:**

1. **TestInvoiceFinancialsModel:**
   - `test_creates_valid_model` - basic creation
   - `test_validates_integrity` - raises ValueError on net+tax != gross
   - `test_calculates_tax_rate` - property works correctly
   - `test_handles_zero_tax` - zero tax doesn't cause division errors
   - `test_model_is_immutable` - frozen config works
   - Import model directly: `from src.models.invoice_financials import InvoiceFinancials`

2. **TestFromKledoInvoice:**
   - `test_converts_valid_invoice` - correct field mapping
   - `test_converts_zero_tax_invoice` - handles zero tax
   - `test_includes_metadata` - invoice_id and ref_number captured
   - `test_excludes_metadata_when_requested` - include_metadata=False works
   - `test_raises_on_missing_field` - KeyError for missing required field
   - `test_raises_on_integrity_failure` - ValueError on bad data
   - `test_handles_float_values_safely` - no precision loss from floats

3. **TestFromKledoInvoices:**
   - `test_converts_multiple_invoices` - batch works
   - `test_skips_invalid_when_requested` - skip_invalid=True skips bad data
   - `test_raises_on_invalid_by_default` - skip_invalid=False fails fast

4. **TestAggregateFinancials:**
   - `test_aggregates_multiple_invoices` - sums correctly
   - `test_returns_zeros_for_empty_list` - handles edge case

Reference exact test examples from `05-RESEARCH.md` "Test Examples" section.
  </action>
  <verify>
```bash
# Run the specific test file
cd /Users/kevinzakaria/developers/kledo-api-mcp && python -m pytest tests/test_kledo_mapper.py -v --no-cov
```
  </verify>
  <done>
- tests/test_kledo_mapper.py exists with 15+ test cases
- All tests pass
- Tests cover: valid conversion, invalid data, edge cases, batch processing, aggregation
- Tests use real validated invoice data
- Tests import both model (invoice_financials.py) and mapper (kledo_mapper.py)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
```bash
# Run full test suite
cd /Users/kevinzakaria/developers/kledo-api-mcp && python -m pytest tests/test_kledo_mapper.py -v --no-cov

# Verify imports work from expected locations
python -c "
from src.models import InvoiceFinancials
from src.mappers import from_kledo_invoice, from_kledo_invoices, aggregate_financials
print('All imports successful')
"
```
</verification>

<success_criteria>
- InvoiceFinancials model exists with correct fields and validation
- Mapper correctly converts Kledo fields: subtotal->net_sales, total_tax->tax_collected, amount_after_tax->gross_sales
- All 15+ tests pass
- Imports work from `src.models` and `src.mappers`
- No precision loss when handling financial values
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-model-field-mapping/05-01-SUMMARY.md`
</output>
