---
phase: 05-domain-model-field-mapping
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/tools/revenue.py
  - src/tools/invoices.py
  - src/tools/sales_analytics.py
autonomous: true

must_haves:
  truths:
    - "Revenue reports display 'Gross Sales (Penjualan Bruto)' instead of confusing 'Revenue After Tax'"
    - "Sales analytics show 'Net Sales' and 'PPN Collected' with clear Indonesian business terminology"
    - "Invoice listings use self-explanatory field labels that finance team can read directly"
    - "All existing tool functionality preserved (no regressions)"
    - "Tool descriptions updated to reference Gross Sales/Net Sales terminology"
  artifacts:
    - path: "src/tools/revenue.py"
      provides: "Revenue tools using domain model"
      contains: "from_kledo_invoices"
    - path: "src/tools/invoices.py"
      provides: "Invoice tools with clear terminology"
      contains: "Gross Sales|Net Sales"
    - path: "src/tools/sales_analytics.py"
      provides: "Sales analytics using domain model"
      contains: "from_kledo_invoices"
  key_links:
    - from: "src/tools/revenue.py"
      to: "src/mappers/kledo_mapper.py"
      via: "imports mapper functions"
      pattern: "from src\\.mappers\\.kledo_mapper import"
    - from: "src/tools/sales_analytics.py"
      to: "src/mappers/kledo_mapper.py"
      via: "imports mapper functions"
      pattern: "from src\\.mappers\\.kledo_mapper import"
---

<objective>
Update revenue, invoice, and sales analytics tools to use the new domain model with clear business terminology.

Purpose: Replace confusing Kledo field names with clear terms throughout the analytics tools. Users will see "Gross Sales (Penjualan Bruto)" instead of "Revenue After Tax", making reports self-explanatory.

Output:
- Updated `src/tools/revenue.py` using domain model
- Updated `src/tools/invoices.py` with clear terminology
- Updated `src/tools/sales_analytics.py` using domain model
</objective>

<execution_context>
@~/.claude/gsd-css/workflows/execute-plan.md
@~/.claude/gsd-css/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-domain-model-field-mapping/05-RESEARCH.md
@.planning/phases/05-domain-model-field-mapping/05-01-SUMMARY.md
@src/tools/revenue.py
@src/tools/invoices.py
@src/tools/sales_analytics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update revenue.py to use domain model</name>
  <files>src/tools/revenue.py</files>
  <action>
Update `src/tools/revenue.py` to use domain model instead of raw Kledo fields:

1. **Add imports:**
```python
from src.mappers.kledo_mapper import from_kledo_invoices, aggregate_financials
```

2. **Update `_revenue_summary()` function:**

BEFORE (current):
```python
revenue_before_tax = sum(float(safe_get(inv, "subtotal", 0)) for inv in invoices)
total_tax = sum(float(safe_get(inv, "total_tax", 0)) for inv in invoices)
revenue_after_tax = sum(float(safe_get(inv, "amount_after_tax", 0)) for inv in invoices)
```

AFTER (domain model):
```python
# Convert to domain model
financial_data = from_kledo_invoices(invoices, skip_invalid=True, include_metadata=False)
summary = aggregate_financials(financial_data)

# Use clear terminology
total_net_sales = summary.net_sales
total_tax_collected = summary.tax_collected
total_gross_sales = summary.gross_sales
```

3. **Update report output labels:**
```python
result.append("## Financial Overview:")
result.append(f"**Penjualan Bruto (Gross Sales)**: {format_currency(float(total_gross_sales))}")
result.append(f"**PPN Collected**: {format_currency(float(total_tax_collected))}")
result.append(f"**Penjualan Neto (Net Sales)**: {format_currency(float(total_net_sales))}")
```

4. **Update `_customer_revenue_ranking()` function:**
- Use domain model for per-customer aggregation
- Update labels from "Revenue Before Tax" to "Net Sales"
- Update labels from "Revenue After Tax" to "Gross Sales"

5. **Update tool descriptions:**
- Change "Revenue BEFORE tax (subtotal)" to "Net Sales (Penjualan Neto)"
- Change "Revenue AFTER tax (amount_after_tax)" to "Gross Sales (Penjualan Bruto)"

IMPORTANT: Keep `_outstanding_receivables()` using raw fields since it needs `due` field which is NOT part of InvoiceFinancials.
  </action>
  <verify>
```bash
# Verify imports work and functions run without error
python -c "
from src.tools.revenue import get_tools, handle_tool

# Check tools are defined
tools = get_tools()
print(f'Revenue tools: {[t.name for t in tools]}')

# Check descriptions updated
for tool in tools:
    if 'Gross Sales' in tool.description or 'Net Sales' in tool.description:
        print(f'{tool.name}: Updated to domain terminology')
    else:
        print(f'{tool.name}: Still uses old terminology')
"
```
  </verify>
  <done>
- revenue.py imports from_kledo_invoices and aggregate_financials
- _revenue_summary() uses domain model for calculations
- Report output shows "Penjualan Bruto (Gross Sales)" not "Revenue After Tax"
- _customer_revenue_ranking() updated with clear terminology
- Tool descriptions use domain terminology
  </done>
</task>

<task type="auto">
  <name>Task 2: Update invoices.py with clear terminology</name>
  <files>src/tools/invoices.py</files>
  <action>
Update `src/tools/invoices.py` to display domain terminology in output:

1. **Update `_list_sales_invoices()` output:**

BEFORE (current):
```python
result.append(f"**Revenue Before Tax**: {format_currency(total_before_tax)}")
result.append(f"**Tax (PPN)**: {format_currency(total_tax)}")
result.append(f"**Revenue After Tax**: {format_currency(total_after_tax)}")
...
result.append(f"- **Before Tax**: {format_currency(subtotal)}")
result.append(f"- **After Tax**: {format_currency(amount_after_tax)}")
```

AFTER (domain terminology):
```python
result.append(f"**Gross Sales (Penjualan Bruto)**: {format_currency(total_after_tax)}")
result.append(f"**PPN Collected**: {format_currency(total_tax)}")
result.append(f"**Net Sales (Penjualan Neto)**: {format_currency(total_before_tax)}")
...
result.append(f"- **Net Sales**: {format_currency(subtotal)}")
result.append(f"- **Tax**: {format_currency(tax)}")
result.append(f"- **Gross Sales**: {format_currency(amount_after_tax)}")
```

2. **Update variable names for clarity** (internal only, no functional change):
```python
# Rename for clarity
total_gross_sales = total_after_tax  # was total_after_tax
total_net_sales = total_before_tax   # was total_before_tax
```

3. **Update `_list_purchase_invoices()` output:**
- Same terminology changes as sales invoices
- "Total Amount" -> "Gross Amount (Penjualan Bruto)"

4. **Update tool descriptions:**
- Change "revenue before/after tax" to "net sales/gross sales"

NOTE: Do NOT import domain model here - invoice listing shows per-invoice details which need raw fields like `due`, `paid`. Only update output labels for clarity.
  </action>
  <verify>
```bash
python -c "
from src.tools.invoices import get_tools

tools = get_tools()
for tool in tools:
    # Check invoice_list_sales description updated
    if tool.name == 'invoice_list_sales':
        if 'net sales' in tool.description.lower() or 'gross sales' in tool.description.lower():
            print('invoice_list_sales: Updated terminology')
        else:
            print('invoice_list_sales: Description could use update')
    print(f'{tool.name} loaded OK')
"
```
  </verify>
  <done>
- Invoice list output uses "Gross Sales (Penjualan Bruto)", "Net Sales (Penjualan Neto)" terminology
- Per-invoice details show clear field labels
- Purchase invoice output updated similarly
- Tool descriptions reference clear terminology
  </done>
</task>

<task type="auto">
  <name>Task 3: Update sales_analytics.py to use domain model</name>
  <files>src/tools/sales_analytics.py</files>
  <action>
Update `src/tools/sales_analytics.py` to use domain model:

1. **Add imports:**
```python
from src.mappers.kledo_mapper import from_kledo_invoice
from src.models.invoice_financials import InvoiceFinancials
```

2. **Update `_sales_rep_revenue_report()` function:**

BEFORE (current):
```python
subtotal = Decimal(str(invoice.get("subtotal", 0)))
tax_amount = Decimal(str(invoice.get("total_tax", 0)))
amount_after_tax = Decimal(str(invoice.get("amount_after_tax", 0)))

sales_rep_data[rep_key]["revenue_before_tax"] += subtotal
sales_rep_data[rep_key]["revenue_after_tax"] += amount_after_tax
```

AFTER (domain model):
```python
# Convert single invoice to domain model (skip conversion failures)
try:
    financials = from_kledo_invoice(invoice, include_metadata=False)
except (ValueError, KeyError):
    continue  # Skip invalid invoices

sales_rep_data[rep_key]["net_sales"] += financials.net_sales
sales_rep_data[rep_key]["gross_sales"] += financials.gross_sales
sales_rep_data[rep_key]["tax_collected"] += financials.tax_collected
```

3. **Update data structure keys:**
```python
sales_rep_data = defaultdict(lambda: {
    "net_sales": Decimal(0),        # was "revenue_before_tax"
    "gross_sales": Decimal(0),      # was "revenue_after_tax"
    "tax_collected": Decimal(0),    # was "total_tax"
    "invoice_count": 0,
    "customer_ids": set(),
    "invoices": [],
    "monthly_net_sales": defaultdict(Decimal),    # was "monthly_revenue_before_tax"
    "monthly_gross_sales": defaultdict(Decimal)   # was "monthly_revenue_after_tax"
})
```

4. **Update report headers:**
```python
format_markdown_table(
    headers=["Sales Rep", "Net Sales", "Gross Sales", "Invoices", "Customers", "Avg Deal"],
    rows=summary_data
)
```

5. **Update `_sales_rep_list()` function:**
- Same pattern: rename `revenue_before_tax` -> `net_sales`, `revenue_after_tax` -> `gross_sales`
- Update table headers

6. **Update tool descriptions:**
- Change "Revenue BEFORE tax (subtotal)" to "Net Sales (Penjualan Neto)"
- Change "Revenue AFTER tax (amount_after_tax)" to "Gross Sales (Penjualan Bruto)"
  </action>
  <verify>
```bash
python -c "
from src.tools.sales_analytics import get_tools, handle_tool

tools = get_tools()
for tool in tools:
    print(f'{tool.name}: loaded OK')
    if 'Net Sales' in tool.description or 'Gross Sales' in tool.description:
        print(f'  - Updated to domain terminology')
    elif 'before tax' in tool.description.lower():
        print(f'  - WARNING: Still uses old terminology')
"
```
  </verify>
  <done>
- sales_analytics.py imports domain model functions
- _sales_rep_revenue_report() uses domain model for aggregation
- Report headers show "Net Sales", "Gross Sales" (not "Revenue Before/After Tax")
- _sales_rep_list() updated with clear terminology
- Tool descriptions use domain terminology
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
cd /Users/kevinzakaria/developers/kledo-api-mcp

# 1. Verify all tools load without import errors
python -c "
from src.tools import revenue, invoices, sales_analytics
print('revenue tools:', [t.name for t in revenue.get_tools()])
print('invoice tools:', [t.name for t in invoices.get_tools()])
print('analytics tools:', [t.name for t in sales_analytics.get_tools()])
print('All tools load OK')
"

# 2. Run existing tests to ensure no regressions
python -m pytest tests/test_tools_invoices.py -v --no-cov -x

# 3. Grep for old terminology - should find minimal occurrences (only in comments/docs)
echo "Checking for old terminology in tools..."
grep -r "revenue_before_tax\|revenue_after_tax" src/tools/ || echo "No old variable names found (good)"
grep -r "Before Tax\|After Tax" src/tools/ && echo "Some output labels may still use old terms" || echo "Output labels updated"
```
</verification>

<success_criteria>
- All three tool files updated with domain terminology
- revenue.py and sales_analytics.py use domain model imports
- Report outputs display "Gross Sales (Penjualan Bruto)", "Net Sales (Penjualan Neto)", "PPN Collected"
- Tool descriptions updated to reflect new terminology
- All existing tests pass (no regressions)
- No Python import errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-domain-model-field-mapping/05-02-SUMMARY.md`
</output>
