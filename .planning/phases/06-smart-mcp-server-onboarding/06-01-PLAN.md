---
phase: 06-smart-mcp-server-onboarding
plan: 01
type: execute
wave: 1
depends_on: [05-02]
files_modified: [src/setup.py, src/config_manager.py]
autonomous: true

must_haves:
  truths:
    - "Setup wizard runs interactively on first execution"
    - "API key validation catches invalid credentials before proceeding"
    - "Configuration is saved to .env file with correct structure"
    - "First-run detection accurately identifies when setup is needed"
  artifacts:
    - path: "src/setup.py"
      provides: "SetupWizard class with interactive prompts"
      min_lines: 150
      exports: ["SetupWizard", "run_setup_wizard"]
    - path: "src/config_manager.py"
      provides: "Configuration validation and .env creation"
      min_lines: 100
      exports: ["ConfigManager", "validate_api_key", "create_env_file"]
  key_links:
    - from: "src/setup.py"
      to: "src/config_manager.py"
      via: "ConfigManager for validation and file writing"
      pattern: "ConfigManager\\(\\)"
    - from: "src/setup.py"
      to: "src/auth.py"
      via: "KledoAuthenticator for connection testing"
      pattern: "KledoAuthenticator\\("
---

<objective>
Build the foundation for one-command setup: interactive wizard, first-run detection, and configuration management.

Purpose: Eliminate manual .env editing and JSON configuration complexity for new users
Output: Working setup wizard that can create .env, validate credentials, and detect first-run state
</objective>

<execution_context>
@~/.claude/gsd-css/workflows/execute-plan.md
@~/.claude/gsd-css/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current codebase patterns
@src/auth.py
@src/server.py
@kledo_mcp.py
@.env.example

# Prior phase context
@.planning/phases/05-domain-model-field-mapping/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create ConfigManager for .env validation and creation</name>
  <files>src/config_manager.py</files>
  <action>
Create `src/config_manager.py` with:

**ConfigManager class:**
- `validate_api_key(api_key: str) -> tuple[bool, str]` - Validate format (starts with "kledo_pat_" or at least 20 chars), returns (is_valid, error_message)
- `validate_base_url(url: str) -> tuple[bool, str]` - Validate URL format, must be https
- `create_env_file(config: dict) -> bool` - Write .env with proper structure matching .env.example
- `env_file_exists() -> bool` - Check if .env exists and has KLEDO_API_KEY set
- `load_current_config() -> dict | None` - Read existing .env if present

**Key behaviors:**
- Use python-dotenv for .env handling (already in dependencies)
- Template from .env.example structure
- Include helpful comments in generated .env
- Handle file write errors gracefully
- No external dependencies beyond stdlib + python-dotenv

**Why these specifics:**
- API key format check prevents obvious typos before API call
- Template ensures all required vars present
- Graceful errors prevent setup wizard crash mid-flow
  </action>
  <verify>
Run: `python -c "from src.config_manager import ConfigManager; cm = ConfigManager(); print(cm.validate_api_key('kledo_pat_test123456789'))"`
Should output: `(True, '')` or similar success indicator
  </verify>
  <done>
- ConfigManager class exists with all methods
- API key validation accepts "kledo_pat_" prefix or 20+ char strings
- URL validation requires https://
- .env creation writes to project root
- No import errors when importing ConfigManager
  </done>
</task>

<task type="auto">
  <name>Create SetupWizard with interactive prompts</name>
  <files>src/setup.py</files>
  <action>
Create `src/setup.py` with:

**SetupWizard class:**
- `__init__(self, config_manager: ConfigManager | None = None)` - Injectable ConfigManager
- `detect_first_run() -> bool` - Check if .env exists and has valid config using ConfigManager
- `prompt_api_key() -> str` - Interactive input with guidance text
- `test_connection(api_key: str, base_url: str) -> tuple[bool, str]` - Use KledoAuthenticator to validate credentials
- `save_configuration(config: dict) -> bool` - Use ConfigManager to write .env
- `run() -> bool` - Orchestrate full wizard flow, return success status

**Interactive prompts (use input()):**

1. Welcome message explaining setup
2. API key prompt:
   ```
   Enter your Kledo API key (starts with 'kledo_pat_'):
   You can get this from: https://kledo.com → Settings → Integration → API
   >
   ```
3. Base URL prompt (default: https://api.kledo.com/api/v1):
   ```
   Kledo API base URL [https://api.kledo.com/api/v1]:
   ```
4. After saving: "✓ Configuration saved to .env"
5. Connection test: "Testing connection to Kledo API..."
6. Success: "✓ Connection successful! Your Kledo MCP server is ready."

**Color output using ANSI codes (no external deps):**
- Green (success): `\033[92m✓\033[0m`
- Red (error): `\033[91m✗\033[0m`
- Yellow (warning): `\033[93m⚠\033[0m`

**run_setup_wizard() function:**
Module-level function that creates SetupWizard instance and runs it.
Returns exit code (0=success, 1=failure).

**Why these specifics:**
- Separate wizard class from runner allows testing
- ConfigManager injection enables unit testing without file I/O
- ANSI codes standard across terminals, no dependency on colorama
- Clear prompts with URLs reduce support burden
  </action>
  <verify>
1. Import test: `python -c "from src.setup import SetupWizard; print('OK')"`
2. First-run detection: `python -c "from src.setup import SetupWizard; w = SetupWizard(); print(w.detect_first_run())"`
3. Check ANSI codes present in prompts
  </verify>
  <done>
- SetupWizard class exists with all methods
- Interactive prompts include helpful URLs and defaults
- Color-coded output works (green/red/yellow ANSI)
- First-run detection checks .env existence
- Connection test uses existing KledoAuthenticator
- run_setup_wizard() function returns 0 or 1
  </done>
</task>

<task type="auto">
  <name>Add unit tests for first-run logic and validation</name>
  <files>tests/test_setup_wizard.py</files>
  <action>
Create `tests/test_setup_wizard.py` with pytest tests:

**Test ConfigManager:**
- `test_validate_api_key_valid()` - Valid formats accepted
- `test_validate_api_key_invalid()` - Short strings rejected
- `test_validate_base_url_valid()` - HTTPS URLs accepted
- `test_validate_base_url_invalid()` - HTTP and malformed rejected
- `test_env_file_exists()` - Detection logic (use tmp_path fixture)

**Test SetupWizard:**
- `test_detect_first_run_no_env()` - Returns True when .env missing
- `test_detect_first_run_with_env()` - Returns False when .env exists
- `test_save_configuration()` - Creates .env with correct content (use tmp_path)

**Use pytest fixtures:**
- Mock ConfigManager for SetupWizard tests
- Use `tmp_path` fixture for file system tests
- No actual API calls (mock KledoAuthenticator)

**Why these specifics:**
- Unit tests validate edge cases without network calls
- tmp_path ensures tests don't pollute project directory
- Mock ConfigManager allows testing wizard flow independently
  </action>
  <verify>
Run: `pytest tests/test_setup_wizard.py -v`
Should show: All tests passed, coverage > 80%
  </verify>
  <done>
- Tests exist for all validation functions
- Tests use tmp_path for file system isolation
- Tests mock external dependencies (auth, API)
- All tests pass
- No side effects in project directory
  </done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from src.setup import SetupWizard; from src.config_manager import ConfigManager"`
2. API key validation: Test valid/invalid formats
3. First-run detection: Verify .env existence check
4. Unit tests: `pytest tests/test_setup_wizard.py -v`
</verification>

<success_criteria>
- [ ] ConfigManager validates API keys and URLs correctly
- [ ] SetupWizard detects first-run state accurately
- [ ] Interactive prompts display with color codes
- [ ] Configuration can be saved to .env file
- [ ] Connection test uses existing KledoAuthenticator
- [ ] Unit tests pass with >80% coverage
- [ ] No external dependencies added (use stdlib + existing)
</success_criteria>

<output>
After completion, create `.planning/phases/06-smart-mcp-server-onboarding/06-01-SUMMARY.md`
</output>
